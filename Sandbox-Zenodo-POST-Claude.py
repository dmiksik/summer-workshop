# %% [markdown]
# # Workshop: Vlo≈æen√≠ datasetu do Zenodo p≈ôes REST API
# 
# Tento notebook demonstruje cel√Ω proces vytvo≈ôen√≠ z√°znamu a vlo≈æen√≠ dat do sandbox.zenodo.org
# 
# ## Pot≈ôebn√© knihovny a nastaven√≠

# %%
import requests
import json
import yaml
import os
from pathlib import Path
from datetime import datetime
import time

# Nastaven√≠ pro sandbox Zenodo
ZENODO_API_URL = "https://sandbox.zenodo.org/api"
ACCESS_TOKEN = "your_access_token_here"  # Nahraƒète sv√Ωm access tokenem

# Hlaviƒçky pro API po≈æadavky
headers = {
    'Content-Type': 'application/json',
    'Authorization': f'Bearer {ACCESS_TOKEN}'
}

print("üîß Nastaven√≠ API p≈ôipraveno")
print(f"API URL: {ZENODO_API_URL}")
print(f"Token nastaven: {'‚úì' if ACCESS_TOKEN != 'your_access_token_here' else '‚úó'}")

# %% [markdown]
# ## Krok 1: Naƒçten√≠ metadat ze YAML souboru

# %%
# Naƒçteme metadata z YAML souboru
yaml_file = "record_test.yaml"

try:
    with open(yaml_file, 'r', encoding='utf-8') as f:
        metadata_yaml = yaml.safe_load(f)
    
    print("üìÑ YAML metadata √∫spƒõ≈°nƒõ naƒçtena:")
    print(f"N√°zev: {metadata_yaml['title']}")
    print(f"Datum publikace: {metadata_yaml['publication_date']}")
    print(f"Typ zdroje: {metadata_yaml['resource_type']}")
    print(f"Poƒçet autor≈Ø: {len(metadata_yaml['creators'])}")
    print(f"Jazyk: {metadata_yaml['language']['title']}")
    print(f"Licence: {metadata_yaml['license']['id']}")
    
    # Zobraz√≠me i dal≈°√≠ pole pokud existuj√≠
    if 'subjects' in metadata_yaml:
        print(f"Subjects: {len(metadata_yaml['subjects'])} polo≈æek")
    if 'contributors' in metadata_yaml:
        print(f"Contributors: {len(metadata_yaml['contributors'])} osob")
    if 'communities' in metadata_yaml:
        print(f"Communities: {len(metadata_yaml['communities'])} komunit")
    if 'funding' in metadata_yaml:
        print(f"Funding: {len(metadata_yaml['funding'])} grant≈Ø")
    
except FileNotFoundError:
    print(f"‚ùå Soubor {yaml_file} nebyl nalezen!")
    print("Vytvo≈ô√≠me testovac√≠ metadata...")
    
    # Fallback testovac√≠ data
    metadata_yaml = {
        'title': 'Uk√°zkov√Ω dataset pro workshop',
        'publication_date': '2025-07-15',
        'resource_type': 'dataset',
        'creators': [
            {
                'given_name': 'Jan',
                'family_name': 'Nov√°k',
                'orcid': '0000-0001-2345-6789',
                'affiliation_text': 'Masarykova univerzita'
            }
        ],
        'description': 'Kr√°tk√Ω popis datasetu pro workshop',
        'keywords': ['machine learning', 'workshop', 'demo'],
        'language': {'id': 'cs', 'title': 'ƒåe≈°tina'},
        'license': {'id': 'cc-by-4.0'}
    }

# %% [markdown]
# ## Krok 2: Transformace metadat do form√°tu Zenodo

# %%
def convert_yaml_to_zenodo(yaml_data):
    """Konvertuje YAML metadata do form√°tu po≈æadovan√©ho Zenodo API"""
    
    # Konverze data do string form√°tu (pokud je to date objekt)
    pub_date = yaml_data['publication_date']
    if hasattr(pub_date, 'strftime'):
        pub_date = pub_date.strftime('%Y-%m-%d')
    else:
        pub_date = str(pub_date)
    
    # Z√°kladn√≠ metadata
    zenodo_metadata = {
        'title': yaml_data['title'],
        'upload_type': 'dataset',
        'description': yaml_data.get('description', ''),
        'publication_date': pub_date,
        'language': yaml_data['language']['id']
    }
    
    # Auto≈ôi
    creators = []
    for creator in yaml_data.get('creators', []):
        zenodo_creator = {
            'name': f"{creator['family_name']}, {creator['given_name']}"
        }
        if 'orcid' in creator:
            zenodo_creator['orcid'] = creator['orcid']
        if 'affiliation_text' in creator:
            zenodo_creator['affiliation'] = creator['affiliation_text']
        creators.append(zenodo_creator)
    
    zenodo_metadata['creators'] = creators
    
    # Kl√≠ƒçov√° slova
    if 'keywords' in yaml_data:
        zenodo_metadata['keywords'] = yaml_data['keywords']
    
    # P≈ôedmƒõty/subjects z kontrolovan√©ho slovn√≠ku
    if 'subjects' in yaml_data:
        subjects = []
        for subject in yaml_data['subjects']:
            subject_entry = {
                'term': subject['term'],
                'identifier': subject['identifier']
            }
            # scheme se automaticky detekuje, ale m≈Ø≈æeme ho poslat
            if 'scheme' in subject:
                subject_entry['scheme'] = subject['scheme']
            subjects.append(subject_entry)
        zenodo_metadata['subjects'] = subjects
    
    # Licence
    if 'license' in yaml_data:
        zenodo_metadata['license'] = yaml_data['license']['id']
    
    # Contributors (p≈ôispƒõvatel√©)
    if 'contributors' in yaml_data:
        contributors = []
        for contributor in yaml_data['contributors']:
            zenodo_contributor = {
                'name': contributor['name'],
                'type': contributor['type']
            }
            if 'affiliation' in contributor:
                zenodo_contributor['affiliation'] = contributor['affiliation']
            if 'orcid' in contributor:
                zenodo_contributor['orcid'] = contributor['orcid']
            contributors.append(zenodo_contributor)
        zenodo_metadata['contributors'] = contributors
    
    # Communities (komunity)
    if 'communities' in yaml_data:
        communities = []
        for community in yaml_data['communities']:
            if isinstance(community, dict) and 'id' in community:
                communities.append({'identifier': community['id']})
            elif isinstance(community, str):
                communities.append({'identifier': community})
        if communities:
            zenodo_metadata['communities'] = communities
    
    # Financov√°n√≠ - spr√°vn√Ω form√°t podle Zenodo API dokumentace
    if 'funding' in yaml_data:
        grants = []
        for fund in yaml_data['funding']:
            # Pokud m√° grant_id, pou≈æijeme ho
            if 'grant_id' in fund:
                grant_id = str(fund['grant_id'])
                # Pokud m√° funder_identifier, pou≈æijeme DOI-prefixed form√°t (doporuƒçen√Ω)
                if 'funder_identifier' in fund and fund['funder_identifier'].startswith('10.13039/'):
                    grant_id = f"{fund['funder_identifier']}::{grant_id}"
                grants.append({'id': grant_id})
            # Alternativnƒõ pokud m√° award_number a je to EC grant
            elif 'award_number' in fund and 'funder_name' in fund:
                if 'Evropsk' in fund['funder_name'] or 'European' in fund['funder_name']:
                    # Pokus√≠me se extrahovat ƒç√≠slo grantu z award_number
                    award_num = fund['award_number'].replace('GA', '').replace('-', '')
                    if award_num.isdigit():
                        grants.append({'id': award_num})
        
        if grants:
            zenodo_metadata['grants'] = grants
    
    # Souvisej√≠c√≠ identifik√°tory - pouze DOI
    if 'related_identifiers' in yaml_data:
        related_identifiers = []
        for rel_id in yaml_data['related_identifiers']:
            # Filtrujeme pouze DOI nebo berme v≈°echny pokud scheme nen√≠ definov√°no
            if 'scheme' not in rel_id or rel_id['scheme'] == 'doi':
                related_identifiers.append({
                    'identifier': rel_id['identifier'],
                    'relation': rel_id['relation_type']
                    # 'scheme' se nepos√≠l√° - Zenodo ho automaticky detekuje z form√°tu
                })
        if related_identifiers:
            zenodo_metadata['related_identifiers'] = related_identifiers
    
    # Ujist√≠me se, ≈æe description nen√≠ pr√°zdn√Ω
    if not zenodo_metadata['description']:
        zenodo_metadata['description'] = f"Dataset: {yaml_data['title']}"
    
    return zenodo_metadata

# Konvertujeme metadata
zenodo_metadata = convert_yaml_to_zenodo(metadata_yaml)

print("üîÑ Metadata konvertov√°na do form√°tu Zenodo:")
print(f"üìã Odes√≠lan√° pole: {list(zenodo_metadata.keys())}")
try:
    print(json.dumps(zenodo_metadata, indent=2, ensure_ascii=False))
except TypeError as e:
    print(f"‚ùå Chyba p≈ôi serializaci JSON: {e}")
    print("üìã Metadata (bez JSON form√°tov√°n√≠):")
    for key, value in zenodo_metadata.items():
        print(f"  {key}: {value} (typ: {type(value).__name__})")

# %% [markdown]
# ## Krok 3: Vytvo≈ôen√≠ nov√©ho z√°znamu (deposition)

# %%
def create_deposition():
    """Vytvo≈ô√≠ nov√Ω z√°znam v Zenodo"""
    
    url = f"{ZENODO_API_URL}/deposit/depositions"
    
    print(f"üì§ Odes√≠l√°me po≈æadavek na: {url}")
    print(f"Hlaviƒçky: {headers}")
    
    response = requests.post(url, headers=headers, json={})
    
    print(f"üì• Odpovƒõƒè ze serveru:")
    print(f"Status k√≥d: {response.status_code}")
    
    if response.status_code == 201:
        deposition = response.json()
        print("‚úÖ Z√°znam √∫spƒõ≈°nƒõ vytvo≈ôen!")
        print(f"ID z√°znamu: {deposition['id']}")
        print(f"Bucket URL: {deposition['links']['bucket']}")
        print(f"Publish URL: {deposition['links']['publish']}")
        return deposition
    else:
        print("‚ùå Chyba p≈ôi vytv√°≈ôen√≠ z√°znamu:")
        print(f"Chyba: {response.text}")
        return None

# Vytvo≈ô√≠me nov√Ω z√°znam
deposition = create_deposition()

if deposition:
    deposition_id = deposition['id']
    bucket_url = deposition['links']['bucket']
    publish_url = deposition['links']['publish']
    
    print(f"\nüìù Z√°znam vytvo≈ôen s ID: {deposition_id}")

# %% [markdown]
# ## Krok 4: Aktualizace metadat z√°znamu

# %%
def validate_zenodo_metadata(metadata):
    """Validuje metadata p≈ôed odesl√°n√≠m do Zenodo"""
    
    required_fields = ['title', 'upload_type', 'description', 'creators']
    missing_fields = []
    
    for field in required_fields:
        if field not in metadata or not metadata[field]:
            missing_fields.append(field)
    
    if missing_fields:
        print(f"‚ùå Chyb√≠ povinn√° pole: {missing_fields}")
        return False
    
    # Kontrola autor≈Ø
    if not isinstance(metadata['creators'], list) or len(metadata['creators']) == 0:
        print("‚ùå Pole 'creators' mus√≠ b√Ωt nepr√°zdn√Ω seznam")
        return False
    
    for i, creator in enumerate(metadata['creators']):
        if 'name' not in creator or not creator['name']:
            print(f"‚ùå Autor {i+1} nem√° vyplnƒõn√© jm√©no")
            return False
    
    # Kontrola upload_type
    valid_upload_types = ['publication', 'poster', 'presentation', 'dataset', 'image', 'video', 'software', 'lesson', 'physicalobject', 'other']
    if metadata['upload_type'] not in valid_upload_types:
        print(f"‚ùå Neplatn√Ω upload_type: {metadata['upload_type']}")
        print(f"Platn√© hodnoty: {valid_upload_types}")
        return False
    
    print("‚úÖ Metadata pro≈°la validac√≠")
    return True

def update_metadata(deposition_id, metadata):
    """Aktualizuje metadata z√°znamu"""
    
    # Nejprve validujeme metadata
    if not validate_zenodo_metadata(metadata):
        return None
    
    url = f"{ZENODO_API_URL}/deposit/depositions/{deposition_id}"
    
    data = {'metadata': metadata}
    
    print(f"üì§ Aktualizujeme metadata pro z√°znam {deposition_id}")
    print(f"URL: {url}")
    print("Odes√≠lan√° metadata:")
    print(f"üìã Pole: {list(metadata.keys())}")
    try:
        print(json.dumps(data, indent=2, ensure_ascii=False))
    except Exception as e:
        print(f"‚ùå Chyba p≈ôi zobrazen√≠ JSON: {e}")
        print("Metadata bez JSON form√°tu:")
        for key, value in metadata.items():
            print(f"  {key}: {value}")
    
    response = requests.put(url, headers=headers, json=data)
    
    print(f"\nüì• Odpovƒõƒè ze serveru:")
    print(f"Status k√≥d: {response.status_code}")
    
    if response.status_code == 200:
        updated_deposition = response.json()
        print("‚úÖ Metadata √∫spƒõ≈°nƒõ aktualizov√°na!")
        print(f"Nov√Ω n√°zev: {updated_deposition['metadata']['title']}")
        
        # Bezpeƒçn√© zobrazen√≠ autor≈Ø
        creators = updated_deposition['metadata'].get('creators', [])
        author_names = []
        for creator in creators:
            if 'name' in creator:
                author_names.append(creator['name'])
            elif 'given_name' in creator and 'family_name' in creator:
                author_names.append(f"{creator['family_name']}, {creator['given_name']}")
            else:
                author_names.append("Nezn√°m√Ω autor")
        
        print(f"Auto≈ôi: {author_names}")
        return updated_deposition
    else:
        print("‚ùå Chyba p≈ôi aktualizaci metadat:")
        print(f"Chyba: {response.text}")
        print("\nüîç Diagnostika:")
        print(f"Content-Type hlaviƒçky: {response.headers.get('content-type', 'N/A')}")
        
        # Pokus√≠me se parsovat JSON odpovƒõƒè
        try:
            error_data = response.json()
            if 'errors' in error_data:
                print("Detaily chyb:")
                for error in error_data['errors']:
                    print(f"  - {error}")
        except:
            print("Nepoda≈ôilo se parsovat JSON odpovƒõƒè")
        
        return None

# Aktualizujeme metadata pouze pokud m√°me vytvo≈ôen√Ω z√°znam
if 'deposition_id' in locals():
    print("üîç Testujeme postupnƒõ r≈Øzn√© varianty metadat...")
    
    # Zkus√≠me nejprve pouze z√°kladn√≠ metadata
    basic_metadata = {
        'title': zenodo_metadata['title'],
        'upload_type': 'dataset',
        'description': zenodo_metadata['description'],
        'creators': zenodo_metadata['creators']
    }
    
    print("\n1Ô∏è‚É£ Zkou≈°√≠m pouze z√°kladn√≠ metadata:")
    updated_deposition = update_metadata(deposition_id, basic_metadata)
    
    if updated_deposition:
        print("‚úÖ Z√°kladn√≠ metadata funguj√≠! Zkus√≠me p≈ôidat dal≈°√≠ pole...")
        
        # P≈ôid√°me postupnƒõ dal≈°√≠ pole
        extended_metadata = basic_metadata.copy()
        extended_metadata['language'] = zenodo_metadata['language']
        extended_metadata['keywords'] = zenodo_metadata['keywords']
        extended_metadata['license'] = zenodo_metadata['license']
        
        print("\n2Ô∏è‚É£ Zkou≈°√≠m s language, keywords a license:")
        updated_deposition = update_metadata(deposition_id, extended_metadata)
        
        if updated_deposition:
            print("‚úÖ Roz≈°√≠≈ôen√° metadata funguj√≠! Zkus√≠me p≈ôidat grants...")
            
            # P≈ôid√°me grants se spr√°vn√Ωm form√°tem
            full_metadata = extended_metadata.copy()
            if 'grants' in zenodo_metadata:
                full_metadata['grants'] = zenodo_metadata['grants']
                print(f"üìã Grants k p≈ôid√°n√≠: {zenodo_metadata['grants']}")
            
            print("\n3Ô∏è‚É£ Zkou≈°√≠m s grants:")
            updated_deposition = update_metadata(deposition_id, full_metadata)
            
            if updated_deposition:
                print("‚úÖ Metadata s grants funguj√≠! Zkus√≠me p≈ôidat v≈°echna zb√Ωvaj√≠c√≠ pole...")
                
                # P≈ôid√°me v≈°echna zb√Ωvaj√≠c√≠ pole z konvertovan√Ωch metadata
                complete_metadata = full_metadata.copy()
                
                # P≈ôid√°me pole pouze pokud existuj√≠ v zenodo_metadata
                additional_fields = ['related_identifiers', 'subjects', 'contributors', 'communities']
                for field in additional_fields:
                    if field in zenodo_metadata:
                        complete_metadata[field] = zenodo_metadata[field]
                        if isinstance(zenodo_metadata[field], list):
                            print(f"üìã P≈ôid√°v√°m {field}: {len(zenodo_metadata[field])} polo≈æek")
                        else:
                            print(f"üìã P≈ôid√°v√°m {field}: {zenodo_metadata[field]}")
                
                print(f"\n4Ô∏è‚É£ Zkou≈°√≠m kompletn√≠ metadata s poli: {list(complete_metadata.keys())}")
                updated_deposition = update_metadata(deposition_id, complete_metadata)
    else:
        print("‚ùå Ani z√°kladn√≠ metadata nefunguj√≠. Zkus√≠me minim√°ln√≠ verzi...")
        
        # Zkus√≠me √∫plnƒõ minim√°ln√≠ metadata
        minimal_metadata = {
            'title': 'Test Dataset',
            'upload_type': 'dataset',
            'description': 'Test description',
            'creators': [{'name': 'Test, User'}]
        }
        
        print("\nüîß Zkou≈°√≠m minim√°ln√≠ metadata:")
        updated_deposition = update_metadata(deposition_id, minimal_metadata)

# %% [markdown]
# ## Krok 5: Vytvo≈ôen√≠ uk√°zkov√Ωch dat pro upload

# %%
def create_sample_data():
    """Vytvo≈ô√≠ uk√°zkov√© soubory pro demonstraci uploadu"""
    
    # Vytvo≈ô√≠me adres√°≈ô pro data
    data_dir = Path("sample_data")
    data_dir.mkdir(exist_ok=True)
    
    # Vytvo≈ô√≠me uk√°zkov√Ω CSV soubor
    csv_content = """id,name,value,category
1,Sample A,10.5,machine_learning
2,Sample B,15.2,image_classification
3,Sample C,8.7,shiba_inu
4,Sample D,12.3,machine_learning
5,Sample E,9.8,image_classification"""
    
    csv_file = data_dir / "sample_dataset.csv"
    with open(csv_file, 'w', encoding='utf-8') as f:
        f.write(csv_content)
    
    # Vytvo≈ô√≠me README soubor
    readme_content = """# Uk√°zkov√Ω dataset pro workshop

## Popis
Tento dataset obsahuje uk√°zkov√° data pro demonstraci procesu vlo≈æen√≠ do Zenodo.

## Obsah
- sample_dataset.csv: Hlavn√≠ datov√Ω soubor
- README.md: Tento popis

## Pou≈æit√≠
Dataset je urƒçen pro vzdƒõl√°vac√≠ √∫ƒçely v r√°mci workshopu.

## Licence
CC BY 4.0
"""
    
    readme_file = data_dir / "README.md"
    with open(readme_file, 'w', encoding='utf-8') as f:
        f.write(readme_content)
    
    files_to_upload = [csv_file, readme_file]
    
    print("üìÅ Uk√°zkov√° data vytvo≈ôena:")
    for file_path in files_to_upload:
        file_size = file_path.stat().st_size
        print(f"  - {file_path.name}: {file_size} byt≈Ø")
    
    return files_to_upload

# Vytvo≈ô√≠me uk√°zkov√° data
sample_files = create_sample_data()

# %% [markdown]
# ## Krok 6: Upload soubor≈Ø

# %%
def upload_file(bucket_url, file_path):
    """Nahraje soubor do Zenodo z√°znamu"""
    
    filename = file_path.name
    upload_url = f"{bucket_url}/{filename}"
    
    print(f"üì§ Nahr√°v√°m soubor: {filename}")
    print(f"URL: {upload_url}")
    print(f"Velikost: {file_path.stat().st_size} byt≈Ø")
    
    # P≈ôiprav√≠me hlaviƒçky pro upload (bez Content-Type pro bin√°rn√≠ data)
    upload_headers = {
        'Authorization': f'Bearer {ACCESS_TOKEN}'
    }
    
    with open(file_path, 'rb') as f:
        response = requests.put(upload_url, headers=upload_headers, data=f)
    
    print(f"üì• Odpovƒõƒè ze serveru:")
    print(f"Status k√≥d: {response.status_code}")
    
    if response.status_code in [200, 201]:  # 200 nebo 201 jsou oba √∫spƒõ≈°n√©
        file_info = response.json()
        print(f"‚úÖ Soubor {filename} √∫spƒõ≈°nƒõ nahr√°n!")
        print(f"Velikost na serveru: {file_info['size']} byt≈Ø")
        print(f"MIME type: {file_info['mimetype']}")
        print(f"Kontroln√≠ souƒçet: {file_info['checksum']}")
        return file_info
    else:
        print(f"‚ùå Chyba p≈ôi nahr√°v√°n√≠ souboru {filename}:")
        print(f"Chyba: {response.text}")
        return None

# Nahrajeme v≈°echny soubory
uploaded_files = []
if 'bucket_url' in locals():
    for file_path in sample_files:
        file_info = upload_file(bucket_url, file_path)
        if file_info:
            uploaded_files.append(file_info)
        time.sleep(1)  # Kr√°tk√° pauza mezi uploady

print(f"\nüìä Celkem nahr√°no {len(uploaded_files)} soubor≈Ø")

# %% [markdown]
# ## Krok 7: Kontrola stavu z√°znamu p≈ôed publikov√°n√≠m

# %%
def get_deposition_status(deposition_id):
    """Z√≠sk√° aktu√°ln√≠ stav z√°znamu"""
    
    url = f"{ZENODO_API_URL}/deposit/depositions/{deposition_id}"
    
    print(f"üìã Kontroluji stav z√°znamu {deposition_id}")
    
    response = requests.get(url, headers=headers)
    
    if response.status_code == 200:
        deposition = response.json()
        print("‚úÖ Stav z√°znamu:")
        print(f"N√°zev: {deposition['metadata']['title']}")
        print(f"Stav: {deposition['state']}")
        print(f"Poƒçet soubor≈Ø: {len(deposition['files'])}")
        print(f"Publikov√°no: {'Ano' if deposition['submitted'] else 'Ne'}")
        
        print("\nüìé P≈ôipojen√© soubory:")
        for file_info in deposition['files']:
            print(f"  - {file_info['filename']}: {file_info['filesize']} byt≈Ø")
        
        # Zobraz√≠me tak√© kl√≠ƒçov√° metadata
        metadata = deposition['metadata']
        print(f"\nüìã Metadata:")
        print(f"  - Auto≈ôi: {len(metadata.get('creators', []))}")
        print(f"  - Kl√≠ƒçov√° slova: {len(metadata.get('keywords', []))}")
        if 'subjects' in metadata:
            print(f"  - Subjects: {len(metadata['subjects'])}")
        if 'contributors' in metadata:
            print(f"  - Contributors: {len(metadata['contributors'])}")
        if 'grants' in metadata:
            print(f"  - Grants: {len(metadata['grants'])}")
        
        return deposition
    else:
        print("‚ùå Chyba p≈ôi z√≠sk√°v√°n√≠ stavu:")
        print(f"Chyba: {response.text}")
        return None

# Zkontrolujeme stav z√°znamu
if 'deposition_id' in locals():
    current_deposition = get_deposition_status(deposition_id)

# %% [markdown]
# ## Krok 8: Publikov√°n√≠ z√°znamu (voliteln√©)

# %%
def publish_deposition(deposition_id, confirm=False):
    """Publikuje z√°znam - POZOR: Tato akce je nevratn√°!"""
    
    if not confirm:
        print("‚ö†Ô∏è  VAROV√ÅN√ç: Publikov√°n√≠ z√°znamu je nevratn√° akce!")
        print("üí° Pro skuteƒçn√© publikov√°n√≠ nastavte parametr confirm=True")
        print("üîç V sandbox prost≈ôed√≠ m≈Ø≈æete z√°znam bezpeƒçnƒõ publikovat pro testov√°n√≠")
        return None
    
    url = f"{ZENODO_API_URL}/deposit/depositions/{deposition_id}/actions/publish"
    
    print(f"üì¢ Publikuji z√°znam {deposition_id}")
    print(f"URL: {url}")
    
    response = requests.post(url, headers=headers)
    
    print(f"üì• Odpovƒõƒè ze serveru:")
    print(f"Status k√≥d: {response.status_code}")
    
    if response.status_code == 202:
        published_record = response.json()
        print("üéâ Z√°znam √∫spƒõ≈°nƒõ publikov√°n!")
        print(f"DOI: {published_record['doi']}")
        print(f"URL z√°znamu: {published_record['links']['record_html']}")
        return published_record
    else:
        print("‚ùå Chyba p≈ôi publikov√°n√≠:")
        print(f"Chyba: {response.text}")
        return None

# Uk√°≈æeme mo≈ænost publikov√°n√≠ a skuteƒçnƒõ publikujme (pokud u≈æivatel chce)
print("üì¢ Publikov√°n√≠ z√°znamu:")
if 'deposition_id' in locals():
    print(f"Z√°znam {deposition_id} je p≈ôipraven k publikov√°n√≠.")
    print("‚ö†Ô∏è  POZOR: Publikov√°n√≠ je nevratn√° akce!")
    print()
    print("Pro publikov√°n√≠ spus≈•te:")
    print(f"published_record = publish_deposition({deposition_id}, confirm=True)")
    print()
    
    # Automaticky publikujeme pro workshop (v sandbox prost≈ôed√≠ je to bezpeƒçn√©)
    print("üéì Pro workshop automaticky publikujeme z√°znam...")
    published_record = publish_deposition(deposition_id, confirm=True)
    
    if published_record:
        print("\nüéâ Z√ÅZNAM √öSPƒö≈†Nƒö PUBLIKOV√ÅN!")
        print(f"DOI: {published_record.get('doi', 'N/A')}")
        if 'links' in published_record and 'record_html' in published_record['links']:
            print(f"URL: {published_record['links']['record_html']}")
else:
    print("‚ùå Z√°znam nebyl vytvo≈ôen - nelze publikovat")

# %% [markdown]
# ## Diagnostika communities - proƒç se nevlo≈æila

# %%
def search_communities(query="", size=20):
    """Vyhled√° komunity v Zenodo"""
    
    url = f"{ZENODO_API_URL}/communities"
    params = {
        'size': size
    }
    if query:
        params['q'] = query
    
    print(f"üîç Vyhled√°v√°m komunity...")
    print(f"URL: {url}")
    print(f"Parametry: {params}")
    
    response = requests.get(url, params=params)
    
    print(f"üì• Odpovƒõƒè ze serveru:")
    print(f"Status k√≥d: {response.status_code}")
    
    if response.status_code == 200:
        communities_data = response.json()
        communities = communities_data.get('hits', {}).get('hits', [])
        total = communities_data.get('hits', {}).get('total', 0)
        
        print(f"‚úÖ Nalezeno {total} komunit (zobrazeno prvn√≠ch {len(communities)}):")
        
        for community in communities:
            comm_id = community.get('id', 'N/A')
            title = community.get('metadata', {}).get('title', 'Bez n√°zvu')
            description = community.get('metadata', {}).get('description', '')
            
            print(f"  üìã ID: {comm_id}")
            print(f"     N√°zev: {title}")
            if description and len(description) > 100:
                description = description[:100] + "..."
            print(f"     Popis: {description}")
            print()
        
        return communities
    else:
        print(f"‚ùå Chyba p≈ôi vyhled√°v√°n√≠ komunit:")
        print(f"Chyba: {response.text}")
        return []

def check_community_exists(community_id):
    """Zkontroluje zda komunita existuje"""
    
    url = f"{ZENODO_API_URL}/communities/{community_id}"
    
    print(f"üîç Kontroluji existenci komunity: {community_id}")
    
    response = requests.get(url)
    
    if response.status_code == 200:
        community = response.json()
        print(f"‚úÖ Komunita '{community_id}' existuje!")
        print(f"N√°zev: {community.get('metadata', {}).get('title', 'N/A')}")
        return True
    elif response.status_code == 404:
        print(f"‚ùå Komunita '{community_id}' neexistuje!")
        return False
    else:
        print(f"‚ùì Chyba p≈ôi kontrole komunity: {response.status_code}")
        print(f"Odpovƒõƒè: {response.text}")
        return False

# Zkontrolujeme va≈°i komunitu z YAML
yaml_communities = metadata_yaml.get('communities', [])
if yaml_communities:
    print("üîç KONTROLA KOMUNIT Z YAML:")
    print("=" * 40)
    
    for community in yaml_communities:
        comm_id = community.get('id') if isinstance(community, dict) else community
        print(f"\nKontroluje komunitu: {comm_id}")
        exists = check_community_exists(comm_id)
        
        if not exists:
            print(f"üí° Zkus√≠me vyhledat podobn√© komunity...")
            similar_communities = search_communities(query=comm_id, size=5)

# Vyhledejme workshop komunity
print("\nüéì WORKSHOP KOMUNITY:")
print("=" * 30)
workshop_communities = search_communities(query="workshop", size=10)

# %% [markdown]
# ## Shrnut√≠ workshopu

# %%
print("üéØ SHRNUT√ç WORKSHOPU")
print("=" * 50)

if 'deposition_id' in locals():
    print(f"‚úÖ Z√°znam vytvo≈ôen: ID {deposition_id}")
    print(f"‚úÖ Metadata aktualizov√°na: {zenodo_metadata['title']}")
    print(f"‚úÖ Soubory nahr√°ny: {len(uploaded_files)}")
    print(f"üìã Stav z√°znamu: P≈ôipraven k publikov√°n√≠")
    
    print(f"\nüîó Odkazy:")
    print(f"Sandbox z√°znam: https://sandbox.zenodo.org/deposit/{deposition_id}")
    
    print(f"\nüìä Zpracovan√° metadata:")
    for field in zenodo_metadata.keys():
        if isinstance(zenodo_metadata[field], list):
            print(f"  - {field}: {len(zenodo_metadata[field])} polo≈æek")
        else:
            print(f"  - {field}: ‚úì")
    
else:
    print("‚ùå Z√°znam nebyl vytvo≈ôen - zkontrolujte ACCESS_TOKEN")

print(f"\nüìö Nauƒçili jste se:")
print("‚Ä¢ Jak naƒç√≠st metadata z YAML")
print("‚Ä¢ Jak konvertovat metadata do form√°tu Zenodo")
print("‚Ä¢ Jak vytvo≈ôit nov√Ω z√°znam p≈ôes API")
print("‚Ä¢ Jak nahr√°t soubory")
print("‚Ä¢ Jak publikovat z√°znam")
print("‚Ä¢ Jak ≈ôe≈°it problematick√° pole (grants, subjects, contributors)")

print(f"\nüîß Pro vlastn√≠ pou≈æit√≠:")
print("1. Z√≠skejte access token na https://sandbox.zenodo.org/account/settings/applications/tokens/new/")
print("2. Nahraƒète 'your_access_token_here' sv√Ωm tokenem")
print("3. Pro produkƒçn√≠ pou≈æit√≠ zmƒõ≈àte URL na 'https://zenodo.org/api'")

# %% [markdown]
# ## Dodateƒçn√© utility funkce

# %%
def list_my_depositions():
    """Zobraz√≠ seznam v≈°ech m√Ωch z√°znam≈Ø"""
    
    url = f"{ZENODO_API_URL}/deposit/depositions"
    
    response = requests.get(url, headers=headers)
    
    if response.status_code == 200:
        depositions = response.json()
        print(f"üìã M√°te {len(depositions)} z√°znam≈Ø:")
        
        for dep in depositions:
            status = "Publikov√°no" if dep['submitted'] else "Koncept"
            print(f"  - ID {dep['id']}: {dep['metadata']['title']} ({status})")
            
        return depositions
    else:
        print("‚ùå Chyba p≈ôi z√≠sk√°v√°n√≠ seznamu:")
        print(f"Chyba: {response.text}")
        return []

def delete_deposition(deposition_id):
    """Sma≈æe nepublikovan√Ω z√°znam"""
    
    url = f"{ZENODO_API_URL}/deposit/depositions/{deposition_id}"
    
    response = requests.delete(url, headers=headers)
    
    if response.status_code == 204:
        print(f"‚úÖ Z√°znam {deposition_id} byl smaz√°n")
        return True
    else:
        print(f"‚ùå Chyba p≈ôi maz√°n√≠ z√°znamu {deposition_id}:")
        print(f"Chyba: {response.text}")
        return False

# Uk√°zka utility funkc√≠
print("\nüõ†Ô∏è  UTILITY FUNKCE:")
print("‚Ä¢ list_my_depositions() - zobraz√≠ v≈°echny va≈°e z√°znamy")
print("‚Ä¢ delete_deposition(id) - sma≈æe nepublikovan√Ω z√°znam")
print("‚Ä¢ get_deposition_status(id) - zobraz√≠ detaily z√°znamu")

# Zavolejte nap≈ô√≠klad:
# my_depositions = list_my_depositions()